<!DOCTYPE html>
<html lang="en" id="html-root">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- SEO优化 -->
    <meta name="description" content="Math Rain - An engaging mathematical expression game">
    <meta name="keywords" content="math game, educational, arithmetic, puzzle">

    <!-- 社交分享 -->
    <meta property="og:title" content="Math Rain - Mathematical Expression Game">
    <meta property="og:description" content="Test your math skills with falling expressions!">
    <meta property="og:image" content="path/to/game-screenshot.png">
    <meta name="twitter:card" content="summary_large_image">
    <title id="page-title">Math Rain</title>
    <link rel="icon"
        href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='16' fill='%23667eea'/%3E%3Ctext x='50%25' y='54%25' text-anchor='middle' font-size='28' fill='white' font-family='Segoe UI,Arial' dy='.3em'%3E%F0%9F%A7%AE%3C/text%3E%3C/svg%3E">
    <link rel="stylesheet" href="css/math-rain/math-rain.css">
    <style>
        .language-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            justify-content: center;
        }
        .lang-btn {
            padding: 8px 16px;
            border: 2px solid #667eea;
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }
        .lang-btn:hover {
            background: rgba(102, 126, 234, 0.2);
            transform: translateY(-1px);
        }
        .lang-btn.active {
            background: #667eea;
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        .setting-item .language-selector {
            margin-bottom: 0;
        }
        
        /* Shop styles */
        .current-coins {
            text-align: center;
            font-size: 18px;
            margin-bottom: 20px;
            color: #ffd166;
            font-weight: bold;
        }
        
        .shop-items {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-bottom: 30px;
        }
        
        .shop-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: rgba(102, 126, 234, 0.1);
            border: 2px solid #667eea;
            border-radius: 12px;
            transition: all 0.2s;
        }
        
        .shop-item:hover {
            background: rgba(102, 126, 234, 0.15);
            transform: translateY(-2px);
        }
        
        .item-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }
        
        .item-icon {
            font-size: 28px;
        }
        
        .item-details h3 {
            margin: 0 0 4px 0;
            font-size: 16px;
            color: #f7fafc;
        }
        
        .item-details p {
            margin: 0;
            font-size: 13px;
            color: #a0aec0;
        }
        
        .item-price {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 16px;
            font-weight: bold;
            color: #ffd166;
        }
        
        .buy-btn {
            padding: 8px 16px;
            background: #48bb78;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
        }
        
        .buy-btn:hover {
            background: #38a169;
            transform: scale(1.05);
        }
        
        .buy-btn:disabled {
            background: #4a5568;
            cursor: not-allowed;
            transform: none;
        }
        
        .buy-btn:disabled:hover {
            background: #4a5568;
        }
    </style>
</head>

<body>
    <!-- 游戏容器 -->
    <div id="game-container">
        <!-- 游戏头部信息 -->
        <div id="game-header">
            <div class="score-display">
                <span id="score-label">分数</span>
                <span id="score-value">0</span>
            </div>
            <div class="combo-display">
                <span id="combo-label">连击</span>
                <span id="combo-value">0</span>
            </div>
            <div class="level-display">
                <span id="level-label">等级</span>
                <span id="level-value">1</span>
            </div>
            <div class="time-display">
                <span id="time-label">时间</span>
                <span id="time-value">0</span>
            </div>
            <div class="lives-display">
                <span id="lives-label">生命</span>
                <span id="lives-value">10</span>
            </div>
            <!-- 会话系统UI -->
            <div class="session-display" id="session-display">
                <span id="session-time-label">剩余时间</span>
                <span id="session-time">3:00</span>
            </div>
            <div class="session-target-display" id="session-target-display">
                <span id="session-target-label">目标分数</span>
                <span id="session-target">100</span>
            </div>
            <!-- 升级提示 -->
            <div class="level-up-indicator" id="level-up-indicator" style="display: none;">
                <span>🎯 可升级!</span>
            </div>
        </div>

        <!-- 游戏主区域 -->
        <div id="game-area">
            <!-- 主游戏画布 - 用于Canvas算式和特效动画 -->
            <canvas id="game-canvas"></canvas>
        </div>

        <!-- 目标数字显示区域 -->
        <div id="target-area">
            <div id="target-label">目标数字</div>
            <div id="target-number">5</div>
            <div id="target-hint">点击结果等于此数字的算式</div>
        </div>

        <!-- 游戏控制按钮 -->
        <div id="game-controls">
            <button id="pause-btn" class="control-btn">⏸️ 暂停</button>
            <button id="settings-btn" class="control-btn">⚙️ 设置</button>
            <button id="shop-btn" class="control-btn">🛒 商店</button>
            <button id="theme-btn" class="control-btn">🎨 主题</button>
        </div>

        <!-- 工具栏（道具/技能） -->
        <div id="tool-bar" class="tool-bar">
            <div class="tool-item">
                <button id="freeze-btn" class="tool-btn" title="时间冻结 (快捷键 F)">❄️ Freeze</button>
                <span class="tool-count" id="freeze-count">x0</span>
            </div>
            <div class="tool-item">
                <button id="bomb-btn" class="tool-btn" title="清屏 (快捷键 B)">💣 Bomb</button>
                <span class="tool-count" id="bomb-count">x0</span>
            </div>
            <div class="tool-item">
                <button id="shield-btn" class="tool-btn" title="护盾 (快捷键 S)">🛡️ Shield</button>
                <span class="tool-count" id="shield-count">x0</span>
            </div>
            <div class="tool-item coins">
                <span class="coins-icon">🪙</span>
                <span class="coins-value" id="coins-value">0</span>
            </div>
        </div>
    </div>

    <!-- 游戏开始界面 -->
    <div id="start-screen" class="screen">
        <div class="screen-content">
            <div class="language-selector">
                <button id="lang-zh" class="lang-btn" onclick="selectLanguage('zh')">中文</button>
                <button id="lang-en" class="lang-btn" onclick="selectLanguage('en')">English</button>
            </div>
            <h1 id="game-title">Math Rain</h1>
            <p id="game-subtitle">数字雨</p>
            <div class="difficulty-selection">
                <h3 id="difficulty-title">选择难度</h3>
                <div class="difficulty-buttons">
                    <button class="difficulty-btn selected" data-level="1" id="difficulty-1">入门级 (1-10)</button>
                    <button class="difficulty-btn" data-level="2" id="difficulty-2">初级 (1-20)</button>
                    <button class="difficulty-btn" data-level="3" id="difficulty-3">中级 (10-50)</button>
                    <button class="difficulty-btn" data-level="4" id="difficulty-4">高级 (20-100)</button>
                    <button class="difficulty-btn" data-level="5" id="difficulty-5">专家级 (50-500)</button>
                    <button class="difficulty-btn" data-level="6" id="difficulty-6">大师级 (100-2000)</button>
                </div>
            </div>
            <div class="start-buttons">
                <button id="start-game-btn" class="start-btn">🚀 开始游戏</button>
                <button id="help-btn" class="help-btn">❓ 游戏帮助</button>
            </div>
            <div class="game-rules">
                <h4 id="game-rules-title">游戏规则</h4>
                <ul>
                    <li id="rule-1">点击结果等于目标数字的算式得分</li>
                    <li id="rule-2">连续正确可获得连击加成</li>
                    <li id="rule-3">连续错误会扣分，错误越多扣分越多</li>
                    <li id="rule-4">算式掉落到底部会消失，抓紧时间！</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- 游戏暂停界面 -->
    <div id="pause-screen" class="screen hidden">
        <div class="screen-content">
            <h2 id="pause-title">⏸️ 游戏暂停</h2>
            <button id="resume-btn" class="menu-btn">继续游戏</button>
            <button id="restart-btn" class="menu-btn">重新开始</button>
            <button id="main-menu-btn" class="menu-btn">主菜单</button>
        </div>
    </div>

    <!-- 游戏结束界面 -->
    <div id="game-over-screen" class="screen hidden">
        <div class="screen-content">
            <h2 id="game-over-title">🎮 游戏结束</h2>
            <div class="final-stats">
                <div class="stat-item">
                    <span class="stat-label">最终得分</span>
                    <span id="final-score" class="stat-value">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">最高连击</span>
                    <span id="max-combo" class="stat-value">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">准确率</span>
                    <span id="accuracy" class="stat-value">0%</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">游戏时间</span>
                    <span id="game-time" class="stat-value">0s</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">评级</span>
                    <span id="final-grade" class="stat-value grade">F</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">获得金币</span>
                    <span id="final-coins" class="stat-value coins">+0</span>
                </div>
            </div>
            <div class="game-over-buttons">
                <button id="play-again-btn" class="menu-btn">再玩一次</button>
                <button id="change-difficulty-btn" class="menu-btn">更改难度</button>
                <button id="home-btn" class="menu-btn">返回主页</button>
            </div>
        </div>
    </div>

    <!-- 会话完成界面 -->
    <div id="session-complete-screen" class="screen hidden">
        <div class="screen-content">
            <h2 id="session-complete-title">🎯 会话完成</h2>
            <div class="final-stats">
                <div class="stat-item">
                    <span class="stat-label">最终分数</span>
                    <span id="session-final-score" class="stat-value">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">目标分数</span>
                    <span id="session-target-score" class="stat-value">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">准确率</span>
                    <span id="session-accuracy" class="stat-value">0%</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">最高连击</span>
                    <span id="session-max-combo" class="stat-value">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">会话时长</span>
                    <span id="session-duration" class="stat-value">3 分钟</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">升级达成</span>
                    <span id="session-level-up" class="stat-value">否</span>
                </div>
            </div>
            <div class="session-buttons">
                <button id="session-continue-btn" class="menu-btn primary">继续下一关</button>
                <button id="session-retry-btn" class="menu-btn">重试本关</button>
                <button id="session-menu-btn" class="menu-btn">返回菜单</button>
            </div>
        </div>
    </div>

    <!-- 设置界面 -->
    <div id="settings-screen" class="screen hidden">
        <div class="screen-content">
            <h2 id="settings-title">⚙️ 游戏设置</h2>
            <div class="settings-grid">
                <div class="setting-item">
                    <label for="sound-volume" id="sound-volume-label">音效音量</label>
                    <input type="range" id="sound-volume" min="0" max="100" value="70">
                    <span id="sound-volume-value">70%</span>
                </div>
                <div class="setting-item">
                    <label for="music-volume" id="music-volume-label">背景音乐音量</label>
                    <input type="range" id="music-volume" min="0" max="100" value="50">
                    <span id="music-volume-value">50%</span>
                </div>
                <div class="setting-item">
                    <label for="particle-effects" id="particle-effects-label">粒子效果</label>
                    <input type="checkbox" id="particle-effects" checked>
                </div>
                <div class="setting-item">
                    <label id="language-setting-label">游戏语言</label>
                    <div class="language-selector">
                        <button id="settings-lang-zh" class="lang-btn" onclick="selectLanguage('zh')">中文</button>
                        <button id="settings-lang-en" class="lang-btn" onclick="selectLanguage('en')">English</button>
                    </div>
                </div>
            </div>
            <button id="settings-close-btn" class="menu-btn">关闭设置</button>
        </div>
    </div>

    <!-- 商店界面 -->
    <div id="shop-screen" class="screen hidden">
        <div class="screen-content">
            <h2 id="shop-title">🛒 道具商店</h2>
            <div class="current-coins">
                <span class="coins-icon">🪙</span>
                <span id="shop-coins-value">0</span>
                <span id="shop-coins-label">金币</span>
            </div>
            <div class="shop-items">
                <div class="shop-item">
                    <div class="item-info">
                        <span class="item-icon">❄️</span>
                        <div class="item-details">
                            <h3 id="freeze-shop-title">时间冻结</h3>
                            <p id="freeze-shop-desc">暂时冻结所有下落的表达式</p>
                        </div>
                    </div>
                    <div class="item-price">
                        <span class="price-amount">10</span>
                        <span class="coins-icon">🪙</span>
                    </div>
                    <button id="buy-freeze-btn" class="buy-btn">购买</button>
                </div>
                <div class="shop-item">
                    <div class="item-info">
                        <span class="item-icon">💣</span>
                        <div class="item-details">
                            <h3 id="bomb-shop-title">清屏炸弹</h3>
                            <p id="bomb-shop-desc">清除屏幕上所有表达式</p>
                        </div>
                    </div>
                    <div class="item-price">
                        <span class="price-amount">25</span>
                        <span class="coins-icon">🪙</span>
                    </div>
                    <button id="buy-bomb-btn" class="buy-btn">购买</button>
                </div>
                <div class="shop-item">
                    <div class="item-info">
                        <span class="item-icon">🛡️</span>
                        <div class="item-details">
                            <h3 id="shield-shop-title">生命护盾</h3>
                            <p id="shield-shop-desc">防止一次生命损失</p>
                        </div>
                    </div>
                    <div class="item-price">
                        <span class="price-amount">15</span>
                        <span class="coins-icon">🪙</span>
                    </div>
                    <button id="buy-shield-btn" class="buy-btn">购买</button>
                </div>
            </div>
            <button id="shop-close-btn" class="menu-btn">关闭商店</button>
        </div>
    </div>

    <!-- 帮助界面 -->
    <div id="help-screen" class="screen hidden">
        <div class="screen-content">
            <h2 id="help-title">❓ 游戏帮助</h2>
            <div class="help-section">
                <h3 id="help-objective-title">游戏目标</h3>
                <p id="help-objective-text">点击结果等于目标数字的数学表达式来得分，避免错过正确答案！</p>
            </div>
            <div class="help-section">
                <h3 id="help-controls-title">控制方法</h3>
                <div class="controls-guide">
                    <div class="control-item">
                        <span class="control-key" id="help-click-key">点击/触摸</span>
                        <div class="control-desc">
                            <strong id="help-click-title">选择表达式</strong>
                            <p id="help-click-desc">点击你认为正确的数学表达式</p>
                        </div>
                    </div>
                    <div class="control-item">
                        <span class="control-key" id="help-space-key">空格键</span>
                        <div class="control-desc">
                            <strong id="help-space-title">暂停/继续</strong>
                            <p id="help-space-desc">暂停或继续游戏</p>
                        </div>
                    </div>
                    <div class="control-item">
                        <span class="control-key" id="help-f-key">F键</span>
                        <div class="control-desc">
                            <strong id="help-f-title">使用冻结</strong>
                            <p id="help-f-desc">暂时冻结所有下落的表达式</p>
                        </div>
                    </div>
                    <div class="control-item">
                        <span class="control-key" id="help-b-key">B键</span>
                        <div class="control-desc">
                            <strong id="help-b-title">使用炸弹</strong>
                            <p id="help-b-desc">清除屏幕上所有表达式</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="help-buttons">
                <button id="help-close-btn" class="menu-btn">关闭帮助</button>
                <button id="help-start-btn" class="menu-btn primary">开始游戏</button>
            </div>
        </div>
    </div>

    <!-- Initialize Language and Shop Management -->
    <script>
        // Temporary compatibility functions until modules load
        window.selectLanguage = function(lang) {
            if (window.languageManager) {
                window.languageManager.selectLanguage(lang);
            }
        };
        
        // Update shop interface function for compatibility
        window.updateShopInterface = function() {
            if (window.shopManager) {
                window.shopManager.updateShopInterface();
            }
        };
        
        // Initialize on DOMContentLoaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, waiting for modules...');
        });
    </script>

    <!-- Load Language and Shop Managers -->
    <script type="module">
        try {
            // Import language manager
            const { default: LanguageManager } = await import('./js/math-rain/i18n/language-manager.js');
            window.languageManager = new LanguageManager();
            window.languageManager.initialize();
            
            // Import shop manager  
            const { default: ShopManager } = await import('./js/math-rain/shop-manager.js');
            window.shopManager = new ShopManager();
            
            console.log('✅ Language and Shop managers loaded');
        } catch (error) {
            console.error('❌ Failed to load Language/Shop managers:', error);
        }
    </script>

    <!-- Load Core Dependencies -->
    <script type="module">
        // Import and expose to global scope
        import('./js/config-manager.js').then(module => {
            window.ConfigManager = module.default;
        });
        
        import('./js/performance-monitor.js').then(module => {
            window.PerformanceMonitor = module.default;
        });
        
        import('./js/math-rain/expression-generator.js').then(module => {
            window.ExpressionGenerator = module.default;
        });
        
        import('./js/math-rain/question-bank-manager.js').then(module => {
            window.QuestionBankManager = module.default;
        });
        
        import('./js/math-rain/difficulty-manager.js').then(module => {
            window.DifficultyManager = module.default;
        });
        
        import('./js/math-rain/sound-manager.js').then(module => {
            window.SoundManager = module.default;
        });
        
        import('./js/math-rain/animation-engine.js').then(module => {
            window.AnimationEngine = module.default;
        });
        
        import('./js/math-rain/particle-effects.js').then(module => {
            window.ParticleSystem = module.default;
        }).catch(error => {
            console.warn('ParticleSystem failed to load:', error);
        });
    </script>

    <!-- 加载重构后的核心游戏逻辑 -->
    <script type="module">
        // 等待依赖加载完成后再初始化
        setTimeout(async () => {
            try {
                // 导入游戏主文件 (自动初始化)
                const { default: MathRainGame } = await import('./js/math-rain/main.js');
            } catch (error) {
                console.error('Failed to load Math Rain:', error);
            }
        }, 2000); // 等待2秒确保所有依赖加载完成
    </script>
</body>

</html>